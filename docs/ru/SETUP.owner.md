# Руководство по операциям владельца (Администратор Multisig)

> **Контекст**: Контракт `YurtFraction` предназначен для одного привилегированного владельца, обычно управляемого мультиподписным кошельком. Этот документ описывает, как этот мультиподписной кошелек должен управлять жизненным циклом токенов от начала до конца. Все транзакции должны предлагаться и выполняться через ваш интерфейс мультиподписного кошелька (например, Safe / Gnosis Safe). Замените значения-заполнители на ваши фактические адреса.

---

## 1. Предварительные условия

- Адрес контракта: `0x...` (заполните после развертывания)
- Адрес владельца мультиподписного кошелька: `0x...`
- Стейблкоины, используемые для распределения доходов/выхода (например, ERC‑20, привязанный к UZS)
- Доступ к RPC для цепочки (тестовая сеть или основная сеть) и блок-эксплорер для проверки

Держите ABI `YurtFraction` под рукой (из `forge build` или Etherscan), чтобы вы могли точно составлять calldata.

---

## 2. Начальное развертывание и настройка

1. **Разверните** контракт через утвержденный процесс развертывания (см. `SETUP.prod.md`).
2. **Подтвердите право собственности**: в блок-эксплорере проверьте, что `owner()` равен вашему адресу мультиподписного кошелька.
3. **Добавьте в белый список начальных держателей**:
   - Функция: `addToWhitelist(address[] accounts)`
   - Входные данные: массив адресов инвесторов (включая сам мультиподписной кошелек)
   - Обоснование: только адреса из белого списка могут отправлять/получать токены.
4. **Распределите токены** (если не сделано при развертывании): используйте частное соглашение о распределении для отправки токенов от мультиподписного кошелька инвесторам, пока обе стороны находятся в белом списке.
5. **Запишите метаданные**: установите начальный URI свойства, если необходимо, через `setPropertyURI(string newURI)` (например, ссылка IPFS на раскрытия).

Всегда отправляйте эти действия как предложения мультиподписного кошелька и собирайте необходимые подписи перед выполнением.

---

## 3. Обычные административные задачи

### 3.1 Добавление в белый список и исключение инвесторов

- **Добавить**: `addToWhitelist(address[] accounts)`
- **Удалить**: `removeFromWhitelist(address[] accounts)`

Держите ваш реестр соответствия в синхронизации с белым списком в цепочке. Удаляйте адреса незамедлительно, когда инвесторы выходят.

### 3.2 Приостановка / Возобновление переводов

- `pause()` временно блокирует все переводы (кроме создания/сжигания внутри логики контракта).
- `unpause()` возобновляет переводы.

Используйте только в экстренных случаях или по требованиям регуляторов. Уведомляйте инвесторов перед приостановкой, когда это возможно.

### 3.3 Обновления метаданных

- `setPropertyURI(string newURI)` для публикации обновленных документов раскрытия (хэш IPFS, HTTPS URL и т.д.).

Документируйте каждое изменение метаданных и храните предыдущие версии в архиве для аудитов.

---

## 4. Рабочий процесс распределения доходов

1. **Соберите доход в стейблкоинах** вне цепочки в мультиподписном кошельке.
2. **Добавьте стейблкоин в белый список**: подтвердите адрес контракта токена выплат (должен быть уже утвержден при развертывании).
3. **Внесите средства**:
   - Функция: `depositIncome(address asset, uint256 amount)`
   - `asset` = адрес стейблкоина, `amount` = общая сумма распределения.
   - Убедитесь, что `approve` был предоставлен от мультиподписного кошелька к контракту `YurtFraction` на сумму не менее `amount`.
4. **Начните распределение**:
   - `startDistribution(address asset)`
   - Делает снимок балансов и блокирует распределительный фонд.
   - Возвращает ID снимка (запишите его для отчетности).
5. **Запросы инвесторов**: Держатели индивидуально вызывают `claimIncome(uint256 id)`. Отслеживайте непогашенные балансы через `claimableIncome`.

Мультиподписной кошелек не требует дальнейших действий после шага 4, если инвесторы не сообщают о проблемах.

---

## 5. Процесс выхода / выкупа

1. **Включите режим выхода**: После продажи основного актива вызовите `triggerExit()`.
2. **Внесите средства от продажи**:
   - `depositExitProceeds(address asset, uint256 amount)` для каждого актива выплаты (повторите, если несколько).
   - Убедитесь, что достаточно стейблкоинов для контракта токена.
3. **Выкуп инвесторов**: Держатели вызывают `redeemOnExit(address asset)`, чтобы сжечь свои токены и получить выплаты.
4. **Мониторинг**: Отслеживайте оставшиеся `exitPot[asset]` и `totalSupply()` до тех пор, пока оба не достигнут нуля. Исследуйте любые остаточные балансы и разрешите их перед закрытием книги.

Режим выхода навсегда блокирует новые переводы; только выкупы (сжигания) разрешены после этого.

---

## 6. Процедуры экстренных ситуаций и управления

1. **Экстренная приостановка**:
   - Если обнаружена подозрительная активность, немедленно вызовите `pause()`.
   - Проведите реагирование на инциденты, затем `unpause()`, как только проблема будет решена.
2. **Ротация ключей**:
   - Если участники мультиподписного кошелька меняются, разверните новый мультиподписной кошелек и передайте право собственности через `transferOwnership(newOwner)` (выполняется из старого мультиподписного кошелька).
3. **Обновления контракта**:
   - Не поддерживается. Любые исправления требуют нового развертывания и плана миграции токенов.
4. **Аудиторский след**:
   - Ведите хронологический журнал всех транзакций мультиподписного кошелька (список транзакций Safe или пользовательский реестр).
   - Перекрестно проверяйте с внецепочными записями соответствия.

---

## 7. Контрольный список отчетности

Для каждого распределения или выхода обновите ваши внутренние отчеты следующей информацией:

| Пункт | Подробности |
|-------|-------------|
| ID снимка / распределения | Возвращается `startDistribution` |
| Адрес актива | Используемый контракт стейблкоина |
| Сумма внесенных средств | Точная сумма в цепочке |
| Хэш транзакции | Для вызовов как внесения, так и триггера |
| Завершение запроса | Процент инвесторов, которые сделали запрос |

Поделитесь отчетом с сотрудниками по соблюдению норм и внешними аудиторами по мере необходимости.

---

## 8. Рекомендации по безопасности

- Используйте аппаратные кошельки для подтверждения каждой подписи мультиподписного кошелька.
- Включите модули на цепочке (например, защитные механизмы Safe), чтобы требовать двухступенчатые одобрения для критических функций.
- Ограничьте конечные точки RPC доверенными провайдерами с ограничением скорости и мониторингом.
- Периодически запускайте `forge test` и `forge coverage` против развернутого коммита, чтобы убедиться, что нет неотслеживаемых изменений, ожидающих повторного развертывания без проверки.

---

Следование этому руководству гарантирует, что администратор мультиподписного кошелька сможет привлекать инвесторов, управлять регулярными распределениями доходов, обрабатывать выкупы при выходе и реагировать на экстренные ситуации — все это при ведении подробных записей, подходящих для регуляторов и аудиторов.
