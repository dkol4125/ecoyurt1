# Руководство по развертыванию в производственной среде (Ethereum Testnet и Mainnet)

> **Предупреждение**
>
> Контракты в этом репозитории предоставлены только в образовательных целях (см. `DISCLAIMER.md`). Не **разворачивайте** на публичных сетях без регуляторного одобрения, профессиональных аудитов и соответствующих операционных контролей. Инструкции ниже описывают технический рабочий процесс для команд, которые уже удовлетворили эти требования.

Этот документ предполагает наличие защищенного хоста Linux без предустановленных инструментов блокчейна. Замените значения-заполнители (`...`) на свои собственные секреты инфраструктуры.

---

## 1. Подготовка базовой системы (Linux)

```sh
sudo apt update
sudo apt install -y build-essential git curl pkg-config libssl-dev
```

---

## 2. Установка инструментов Foundry

```sh
curl -L https://foundry.paradigm.xyz | bash
source ~/.foundry/bin/foundryup   # добавляет forge/anvil в PATH
```

Периодически повторно запускайте `foundryup`, чтобы получать обновления безопасности.

---

## 3. Получение снимка релиза

```sh
git clone https://github.com/dkol4125/ecoyurt1.git
cd ecoyurt1
git fetch --tags
git checkout v0.1.0   # замените на проверенный тег релиза
```

---

## 4. Установка зависимостей Solidity

```sh
forge install OpenZeppelin/openzeppelin-contracts@v5.4.0
forge install foundry-rs/forge-std@v1.9.6
```

---

## 5. Проверка перед развертыванием

```sh
forge build
forge test -vv
forge coverage --report lcov --out lcov.info
python3 build/scripts/check-lcov-coverage.py   # должен сообщать о 100% покрытии
```

Архивируйте `lcov.info` вместе с артефактами релиза для аудиторских следов, затем удалите его из рабочего дерева (`rm lcov.info`).

---

## 6. Конфигурация безопасной среды

Создайте `/etc/ecoyurt/credentials` (или аналогичное безопасное место) с правами доступа только для чтения для root (например, `chmod 600`). Определите следующие переменные оболочки перед отправкой любых транзакций:

```sh
export TESTNET_RPC_URL=https://sepolia.infura.io/v3/...
export MAINNET_RPC_URL=https://mainnet.infura.io/v3/...
export DEPLOYER_PK=0x...            # Предпочитайте аппаратные кошельки; никогда не кодируйте в скриптах
export ETHERSCAN_API_KEY=...
```

Никогда не коммитьте эти значения в систему контроля версий. Используйте временные сеансовые оболочки или менеджер секретов.

---

## 7. Пробный запуск в Ethereum Testnet (например, Sepolia)

```sh
$ forge script script/Deploy.s.sol:Deploy \
    --rpc-url "$TESTNET_RPC_URL" \
    --broadcast \
    --skip-simulation \
    --etherscan-api-key "$ETHERSCAN_API_KEY" \
    --verify
```

*Запишите адрес развернутого контракта и хэш транзакции.* Выполните интеграционные проверки:

```sh
$ forge script script/LocalAnvilTest.s.sol:LocalAnvilTest \
    --rpc-url "$TESTNET_RPC_URL" \
    --broadcast
```

Скрипт проверки должен пройти без откатов. Если он не проходит, проведите диагностику и повторно разверните.

---

## 8. Развертывание на Mainnet

После успешной проверки тестовой сети и одобрения заинтересованных сторон:

```sh
$ forge script script/Deploy.s.sol:Deploy \
    --rpc-url "$MAINNET_RPC_URL" \
    --broadcast \
    --skip-simulation \
    --etherscan-api-key "$ETHERSCAN_API_KEY" \
    --verify
```

Сразу экспортируйте развернутый адрес, хэш транзакции и точный SHA коммита Git в ваши записи по соблюдению норм.

---

## 9. Контрольный список после развертывания

- ✅ Подтвердите, что контракт отображается на Etherscan с проверенным исходным кодом.
- ✅ Обновите внутреннюю документацию с развернутыми адресами и ABI.
- ✅ Проведите финальную проверку покрытия и сохраните артефакты.
- ✅ Поменяйте любые открытые API-ключи или временные секреты, использованные во время развертывания.

---

## 10. Регуляторные и операционные заметки

- Консультируйтесь с узбекскими финансовыми регуляторами и юридическими консультантами перед любым использованием в основной сети.
- Поддерживайте многофакторные контрольные механизмы для привилегированной учетной записи владельца и разделяйте ключи от хостов развертывания.
- Запланируйте регулярные сторонние аудиты после каждого значительного изменения кода, даже если покрытие обеспечено.

---

Следование этому руководству обеспечивает воспроизводимость каждого развертывания в производственной среде: исходный код связан с подписанным тегом Git, все тесты и проверки покрытия выполнены, а шаги трансляции отслеживаются как в тестовой сети, так и в основной сети.
